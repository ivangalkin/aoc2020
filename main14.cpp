#include <iostream>
#include <string_view>
#include <tuple>
#include <set>
#include <map>
#include <algorithm>

#include <regex>


using namespace std::string_view_literals;

static std::string input[] = {
        "01101001XXX000000111X1000X0000X11010",
        "9227,2018",
        "2743,107216",
        "7335,5498199",
        "62141,28643",
        "10396,615",
        "44596,16631831",
        "30301,1036820554",
        "0X0010X11100000010011011111010101XX1",
        "25912,1706212",
        "18700,1436",
        "31216,1307",
        "61767,10950397",
        "55019,9351804",
        "5477,970907882",
        "49380,1102790",
        "1100110XX10X10X00001X00010X10XX11111",
        "43431,43329",
        "39748,2295",
        "59160,4068818",
        "X10010101XXX00X010010X1X011001001X1X",
        "783,969",
        "15182,4439242",
        "34082,129773486",
        "3726,36911281",
        "14093,198",
        "7136,967728",
        "1100X1100101000011011000010XX010111X",
        "33093,2500",
        "48387,5485316",
        "56382,38247",
        "19403,4830301",
        "53014,12910126",
        "51746,7221070",
        "1100111011000000X101XX1001111100000X",
        "45506,6583",
        "37356,5047",
        "60299,16732544",
        "34415,233715",
        "38131,3633859",
        "39038,569179",
        "11X011111110XXX01011X0001X000100X0XX",
        "61857,60109927",
        "61984,56703060",
        "25744,85084",
        "19683,146541846",
        "5034,3308207",
        "X1X01100110X01001101001110011000X111",
        "33321,476094",
        "47197,2775",
        "33561,1185",
        "44649,1910953",
        "12452,778855",
        "62667,7299049",
        "30629,942780",
        "11101010110000000X01101X01001111XX01",
        "15304,2029422",
        "47648,224645267",
        "110010000XX0X00000010X0000000X001000",
        "18174,10605",
        "27164,58633252",
        "49380,896",
        "35511,1865",
        "1101X10011111010001100100001X011XX1X",
        "46534,133047049",
        "40985,1546810",
        "19567,322254",
        "13516,5103",
        "43307,220958462",
        "3522,10",
        "00101010110X0000110X100101XX00110000",
        "32856,468089608",
        "16581,1520",
        "44671,493645",
        "59135,743",
        "X1001100010000X00001X1X100X0100011X1",
        "24709,381965",
        "18599,58320",
        "11101110X1000X0X001111XX010110101101",
        "29307,110716",
        "11929,68368314",
        "5595,98625",
        "19842,114448",
        "82,116842679",
        "28608,106081605",
        "38415,166431",
        "11X010001100X000011101101X101X1X0010",
        "64997,537175943",
        "4215,1700",
        "7842,91467205",
        "28677,92497218",
        "42227,309706330",
        "0X00XX1011000010X00X0X0101X100001010",
        "24113,18710",
        "41368,61727257",
        "24910,1216",
        "48962,431244119",
        "52880,31537",
        "26016,3867529",
        "110X100001011000100X001XX10110110111",
        "44808,8860",
        "977,227853",
        "24326,1292",
        "11196,185995",
        "24910,1456794",
        "38209,11963784",
        "2516,206274",
        "10101X010X010011011XXXX01100X0X01X00",
        "37266,53802",
        "43697,3027265",
        "40421,182178",
        "14745,5768586",
        "33359,62113",
        "11X01X0011000X00X101101110XX11XXX101",
        "60299,38321864",
        "13933,4119750",
        "63519,3793",
        "33359,6062406",
        "2145,1197981",
        "01101000110X0X00XX010XX1X0111100X0X0",
        "996,1535",
        "37483,415",
        "36833,15446433",
        "12962,139638950",
        "0X1010101111X00X10010X1X01110111011X",
        "28705,73",
        "46437,145646713",
        "10079,1238645",
        "23342,1856314",
        "7654,259644",
        "X1X010X0110X0000X001XX111X100110X000",
        "32957,365133",
        "13738,43314758",
        "21472,985365",
        "42598,32659669",
        "01101X001100000X01X101X111100000X1X1",
        "39855,17101",
        "6765,846",
        "40866,495565203",
        "56928,3961201",
        "17228,3585",
        "1100101010XX001X100100X0X01111001100",
        "64982,103054",
        "35989,44254616",
        "11366,7715",
        "101010010001001XX11100X0X1100110X011",
        "43005,1741",
        "46533,383034263",
        "30931,2731638",
        "35338,133759116",
        "0010110X011X00X011XX00101000X10X1X00",
        "23302,575430886",
        "41184,484667743",
        "11064,6013819",
        "X10010101X0100X01X01011X1111000XX010",
        "59531,51445",
        "604,65230",
        "25153,57802",
        "42909,16748064",
        "XX10100XXX0X001101X101011100101X0X10",
        "10016,1384",
        "28736,373587",
        "5388,20765",
        "55736,276409152",
        "0X001001100000X0100X0101X0X111010001",
        "713,941",
        "34620,47358",
        "64695,118873278",
        "28381,5504290",
        "9352,1335605",
        "5606,127872",
        "00101010110X0000XXXX0X0101X00X001000",
        "49208,1902856",
        "3726,861821129",
        "51431,217032464",
        "8104,201580051",
        "8561,22666152",
        "27779,25685964",
        "14798,35556100",
        "11001X1XX1X0000010X10010111XX10X0X10",
        "40524,62170024",
        "26151,32735",
        "36331,791",
        "51971,4077",
        "39949,1208881",
        "1110X00011X00100XX0X00111X011X1X0100",
        "49523,45562",
        "65190,437018",
        "48194,590010",
        "34081,2730318",
        "19485,71146",
        "43675,5165",
        "41990,5786294",
        "1100XX00110XXX0000101X000010X11X1X10",
        "46338,969889",
        "56130,19345",
        "56003,108577353",
        "38580,132743",
        "51852,29007",
        "9562,4082929",
        "01X0X0XX11000000100100111X1111X0X000",
        "16562,42746421",
        "10764,78319913",
        "62076,1791961",
        "34147,517873792",
        "6626,46567",
        "56829,132232586",
        "16078,1231",
        "110XXX1101000000101110111X1001X0XX01",
        "36554,734907",
        "24177,794769422",
        "49782,2634",
        "27278,2566029",
        "20585,181",
        "54195,82217823",
        "11101X0111000100X110X011011000X0X1X1",
        "36637,20724",
        "61749,22922812",
        "63812,29576",
        "56928,127412",
        "26016,15698299",
        "63570,546374",
        "010000101100X010X000111XX01110010X0X",
        "42138,20438",
        "773,274846",
        "42598,12492801",
        "1110000XXX0001X011000010100010000100",
        "58846,9689",
        "52001,22660",
        "23579,145885",
        "14525,103",
        "48501,7119",
        "25744,946940111",
        "01XX0010X10000X00000X1X0110101001XX0",
        "58095,2159",
        "39650,116399462",
        "46338,2119",
        "12284,8136087",
        "35849,96530",
        "10X010011100000010010XXXX0111X100X01",
        "11994,7198139",
        "19485,13623414",
        "16072,464968689",
        "11101000110X0X00X1110010X101X0X00010",
        "27871,191670",
        "40370,1062912647",
        "12962,94498",
        "39988,505747636",
        "2651,27293224",
        "00101100X1X00000X1011X1X10X01100X0X0",
        "39511,1228170",
        "12431,22479089",
        "16819,2295885",
        "16562,535",
        "61184,5370560",
        "61728,680",
        "X1101010X1XX00X010010111X1X001X11101",
        "27439,180428",
        "64502,317409",
        "63473,4484",
        "32050,957",
        "17565,451",
        "001X100111X100110101010XX001X0X010X0",
        "38912,11646861",
        "10983,2571733",
        "57574,547761278",
        "21922,936",
        "1110X0001100010001010X111X00X1111001",
        "41652,15",
        "52965,9633",
        "57427,44143",
        "1360,52315",
        "29741,30065628",
        "X1XX100011X000X0XX01100110X10X101000",
        "13738,41784",
        "82,2093225",
        "1X0X1X0X110000000XX11010001010100011",
        "5734,3809359",
        "39002,64194333",
        "45226,582040770",
        "27757,201468",
        "23474,24958",
        "18945,186986435",
        "110011XXX1011000000X100X00111110X1XX",
        "26951,34107",
        "9065,235577282",
        "61339,33344630",
        "X01X1010X1010000011100X1110110101000",
        "46016,799",
        "1032,2537",
        "14956,146596",
        "1110X00011000000XX1X01110010X1001111",
        "44128,2854",
        "7947,311",
        "10438,9703",
        "59531,792206617",
        "61749,93851",
        "64623,1641525",
        "110011001100XX0000011X011X0001100010",
        "42983,45292954",
        "55070,5534",
        "39372,274025469",
        "13952,35023",
        "15926,2673045",
        "111000001100X0X0X11101100010011X0101",
        "30629,8185",
        "64623,21212602",
        "110011000X010X0010XX10001XX01010X001",
        "43528,7668024",
        "19875,92712996",
        "1687,352650669",
        "46581,697",
        "XX0010011X0000001001XX001101000X0XX0",
        "14313,127102653",
        "27061,3071194",
        "15305,2799",
        "64156,520353",
        "11X01X0X1X0001001101001110001X001010",
        "46088,103332",
        "36868,127638504",
        "24173,64518503",
        "51207,27119",
        "32439,31653573",
        "X1X010X0110X000X0101110110X1111X0X0X",
        "30216,6171472",
        "54536,3149",
        "61749,45155816",
        "63428,2285065",
        "21170,526423366",
        "56037,21621",
        "21744,6711",
        "1100111X0101X00011010001100001X0101X",
        "50634,7830",
        "34473,93434803",
        "50697,3975",
        "28736,245436882",
        "36181,68026875",
        "44740,26732",
        "1100XX11X110X0X010111011101XX1000010",
        "8264,2618",
        "22897,492",
        "25514,310547768",
        "14091,1296713",
        "11X01000110000000X11XX11100000X0011X",
        "34147,55819618",
        "713,57753013",
        "43005,734",
        "19147,1261",
        "30629,100095173",
        "11X1111X110X0000010111011011000000X0",
        "45108,255101",
        "14313,4574087",
        "17120,24850",
        "011000011100X000X00100X110110100X110",
        "4230,303831830",
        "56928,5163880",
        "14726,946803",
        "65140,4998",
        "01XX10010X0000010111X111010001101100",
        "48387,244989536",
        "55491,31887",
        "10659,329486493",
        "0111XX0X1100000001111X0101010000X010",
        "35490,7441",
        "38204,2781817",
        "15504,4192042",
        "48165,22254",
        "41344,1275190",
        "31355,727899223",
        "6770,46922",
        "XXXX1XX0110000000X0100X110X110100000",
        "55906,45453",
        "9448,136999865",
        "43310,26035896",
        "64498,31435",
        "11101000110X0X0X1X10011100110X001100",
        "38423,17106",
        "19919,317562128",
        "5388,1437766",
        "11X0100X110001000X1010X00100111X000X",
        "59546,1648175",
        "57429,1451227",
        "10659,3865",
        "35838,304651619",
        "38506,663621",
        "60490,7815",
        "16648,139051458",
        "111110X0111X0X10110100101X11XX00000X",
        "5237,38290",
        "30301,2620",
        "65271,1412405",
        "17030,1268",
        "1848,647",
        "45226,4055568",
        "16123,15303130",
        "01X010X0X100000X01011X0101011X1XXX01",
        "40721,35664047",
        "2541,18078490",
        "19062,8737",
        "56642,109",
        "1732,99084",
        "43287,186566478",
        "1X001110X1110X0X1001110001101XXXXX00",
        "22104,559",
        "17735,54865",
        "38352,437",
        "32396,3144542",
        "13760,139350",
        "00111001X101X011010X0011X0110010X011",
        "27439,25862312",
        "3504,1937287",
        "59498,234476272",
        "29550,1498180",
        "19709,2171",
        "19165,20631",
        "63523,64887100",
        "00X0X0011000000X100101001X0100010000",
        "13738,761575",
        "4342,24952",
        "35511,50203418",
        "27955,46141252",
        "14216,49071218",
        "011X1001X100000X0X11001XX10X100X001X",
        "29346,20677",
        "35091,215097141",
        "40087,1901294",
        "19485,251731879",
        "24684,1467",
        "25815,1857109",
        "62590,216698971",
        "0010101011X0000010110X11100XXXX01110",
        "28741,1680",
        "23948,171",
        "39293,14161274",
        "52880,7933820",
        "X01010010001001101XX101100001000XX00",
        "48409,599454",
        "4215,26481029",
        "15546,10024168",
        "11X01XX0110000000XX11X111111110X1X00",
        "42920,882414611",
        "57574,1289149",
        "30629,809394101",
        "1476,2215",
        "48366,120690110",
        "111010XX110001001X101X11X1100X011000",
        "28951,19045798",
        "37356,14088692",
        "65242,32015",
        "19875,1891",
        "59787,3238036",
        "111010001101X1X0X01001010011010011X0",
        "50947,11958907",
        "50805,4184615",
        "9216,7284",
        "9366,616014",
        "39243,50245671",
        "26151,225",
        "37356,7454",
        "X11010XX110000XX01110X0X110X10100X00",
        "10146,901",
        "16819,1669",
        "49594,30118559",
        "110X101X1X1X0000100100001011X1000001",
        "44462,437397422",
        "46581,122690574",
        "47406,2223301",
        "23302,27350",
        "9227,64749050",
        "32439,830166089",
        "16958,1767",
        "X110111X110000000101100111111000X10X",
        "30526,518919",
        "45088,3881541",
        "28736,101657283",
        "46276,67581",
        "54442,874618503",
        "X10XX11011011X1000X11X00X0X100000000",
        "14438,68398",
        "43123,682",
        "53975,12217",
        "14906,14892",
        "011010111X0000X10111000X0100X0X10111",
        "18099,129190855",
        "24225,60254642",
        "6147,1967266",
        "23568,12452",
        "40866,233049911",
        "01101000110X0X000101X00110011X1X0X00",
        "141,6636298",
        "61767,8072",
        "51955,1084869",
        "28703,86518",
        "49943,1162266",
        "6728,951818288",
        "010010101100001010X100X01111X1000X10",
        "26893,2377486",
        "26841,521",
        "5584,1929",
        "1100X11X01XX00001X011X0X110XX0001100",
        "24300,30584",
        "62220,926355",
        "21879,1802",
        "21963,346",
        "42819,217744624",
        "38442,75344432",
        "11X010010X0000110111X10000X110001X10",
        "49782,331229",
        "37055,264861759",
        "7464,122702",
        "53975,10052271",
        "00101100111X00XX01X11101100011X10XX0",
        "35490,369795318",
        "12330,242078616",
        "XX00X01011X00X00010101X110X011110101",
        "55598,3761622",
        "10193,70536",
        "4694,39620509",
        "40721,424771",
        "33140,154232",
        "26948,37978095",
        "X10X11X011X1101000X1000X10X0X001000X",
        "10734,35783",
        "60994,64736",
        "47530,211",
        "110011111101X00X000X0X10X01001100001",
        "45758,714",
        "33710,3308098",
        "34082,1470",
        "13513,339084",
        "36005,948",
        "22208,54801",
        "11001X00X10XX000X00100X01X1X1010X010",
        "64623,226472",
        "61920,69906",
        "21637,18145978",
        "35989,52932732",
        "XX001011X100000X1001XX10X100X1011010",
        "16277,1953",
        "1820,71",
        "52001,2117192",
        "41507,2489824",
        "63428,4874",
        "01000X11110X0000100110X010X1X0000X0X",
        "50966,649836905",
        "13251,84391",
        "2827,2335210",
        "01X01000X100X0000111X00X1101XX110010",
        "37050,22573528",
        "60994,508",
        "1560,286179",
        "1110110111000100X1101X10000X0010X111",
        "15675,36967016",
        "46000,233496883",
        "34415,2067736",
        "9212,59203547",
        "4474,1218632",
        "18794,248839504",
        "48996,1469",
        "XX0X111011000010X000000X011100111011",
        "2827,265677",
        "38352,14739817",
        "8104,552372",
        "44416,430420",
        "10177,292",
        "27665,233108",
        "X0X010X01101X0000101010X110010100000",
        "26604,97034170",
        "24910,2438352",
        "21800,6131",
        "38442,33942864",
        "11X010X01101X100X0101101101001X01X1X",
        "19403,2412",
        "62888,53930",
        "55471,3757",
        "62415,124924",
        "837,78",
        "11101000110XX00110100X11111101001X11",
        "28580,14210267",
        "61701,21584384",
        "28544,23917",
        "110011X01100000000011110X11X011X0010",
        "24266,4131276",
        "38423,9580",
        "64502,2974919"
};

static std::string input2[]= {
        "XXXXXXXXXXXXXXXXXXXXXXXXXXXXX1XXXX0X",
        "8,11",
        "7,101",
        "8,0"
};

static std::string input3[] = {
        "000000000000000000000000000000X1001X",
        "42,100",
        "00000000000000000000000000000000X0XX",
        "26,1",
};

int _14part1() {
    std::bitset<64> zeromask;
    std::bitset<64> onemask;
    std::bitset<64> rangemask;

    for (size_t i = 0; i < 64; i++) {
        zeromask[i] = 1;
    }

    for (size_t i = 0; i < 64; i++) {
        rangemask[i] = i < 36;
    }

    std::map<uint64_t, std::bitset<64>> memory;

    for ( auto& line : input) {
       if (auto c = line.find(','); c != std::string::npos) {
           auto value = std::bitset<64>{stoull(line.substr(c+1), nullptr, 10)};
           value &= zeromask;
           value &= rangemask;
           value |= onemask;
           memory[stoull(line.substr(0, c), nullptr, 10)] = std::move(value);
       } else if (line.size() == 36) {
            std::string effective;
            effective.append(64-36, 'X');
            effective.append(line);

            std::string effectiveone = effective;
            std::replace(effectiveone.begin(), effectiveone.end(), 'X', '0');
            onemask = std::bitset<64>(effectiveone);

            std::string effectivezero = effective;
            std::replace(effectivezero.begin(), effectivezero.end(), 'X', '1');
            zeromask = std::bitset<64>(effectivezero);
       } else {
           assert(false);
       }
    }

    uint64_t sum = 0;
    for (auto& [_, value] : memory) {
        sum += value.to_ullong();
    }

    std::cout << sum << std::endl;

    return 0;
}

void applyfloating(std::map<uint64_t, uint64_t>& memory, std::vector<uint64_t> floating, std::bitset<64> address, uint64_t value) {
    if (floating.empty()) {
        memory[address.to_ullong()] = value;
        return;
    }

    std::cout << "float size " << floating.size() << std::endl;

    auto bit_nr = floating.back();
    floating.pop_back();

    address[bit_nr] = 0;
    applyfloating(memory, floating, address, value);
    address[bit_nr] = 1;
    applyfloating(memory, floating, address, value);
}

int _14part2() {

    std::bitset<64> rangemask;
    std::bitset<64> onemask;
    std::vector<uint64_t> floating;

    for (size_t i = 0; i < 64; i++) {
        rangemask[i] = i < 36;
    }

    std::map<uint64_t, uint64_t> memory;

    for ( auto& line : input2) {
        std::cout << "PROCESS " << line << std::endl;
       if (auto c = line.find(','); c != std::string::npos) {
           auto addresss = std::bitset<64>{stoull(line.substr(0, c), nullptr, 10)};
           addresss &= rangemask;
           addresss |= onemask;
           applyfloating(memory, floating, addresss, stoull(line.substr(c+1), nullptr, 10));
       } else if (line.size() == 36) {
            std::string effective;
            effective.append(64-36, 'X');
            effective.append(line);

            std::string effectiveone = effective;
            std::replace(effectiveone.begin(), effectiveone.end(), 'X', '0');
            onemask = std::bitset<64>(effectiveone);

            floating =  {} ;
            for (int i = 0; i < line.size(); i++) {
                if (line[i] == 'X') {
                    floating.push_back(35-i);
                }
            }

       } else {
           assert(false);
       }
    }

    uint64_t sum = 0;
    for (auto& [_, value] : memory) {
        sum += value;
    }

    std::cout << sum << std::endl;

    return 0;
}
